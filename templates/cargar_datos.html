{% extends "base.html" %}

{% block title %}Cargar Datos - Sistema de Informes Survey123{% endblock %}

{% block head %}
<style>
    .hidden {
        display: none !important;
    }
    .show {
        display: block !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Encabezado -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h2 class="page-title">
                <i class="fas fa-upload me-3"></i>
                Cargar Archivo Survey123
            </h2>
            <p class="page-subtitle">
                Suba su archivo Excel de Survey123 para procesamiento automático
            </p>
        </div>
    </div>

    <!-- Área de carga de archivos -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="upload-card">
                <div class="upload-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-excel me-2"></i>
                        Seleccionar Archivo
                    </h5>
                </div>
                <div class="upload-card-body">
                    <!-- Zona de drag and drop -->
                    <div class="dropzone" id="dropzone">
                        <div class="dropzone-content">
                            <div class="dropzone-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h4 class="dropzone-title">Arrastra tu archivo aquí</h4>
                            <p class="dropzone-subtitle">o haz clic para seleccionar</p>
                            <div class="dropzone-info">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Tamaño máximo: 16MB • Formatos: .xlsx, .xls
                                </small>
                            </div>
                        </div>
                        <input 
                            type="file" 
                            class="dropzone-input" 
                            id="archivo" 
                            name="archivo" 
                            accept=".xlsx,.xls"
                            aria-label="Seleccionar archivo Excel con datos Survey123"
                            required>
                    </div>

                    <!-- Archivo seleccionado -->
                    <div class="selected-file selected-file-hidden" id="selectedFile">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-excel text-success me-2 fs-4"></i>
                                <div>
                                    <div class="file-name fw-semibold"></div>
                                    <div class="file-size text-muted"></div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFile()" title="Eliminar archivo seleccionado">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <form id="uploadForm" enctype="multipart/form-data" class="upload-form-hidden">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-4" id="btnProcesar">
                                <i class="fas fa-cogs me-2"></i>
                                Procesar Archivo
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="limpiarFormulario()">
                                <i class="fas fa-trash me-2"></i>
                                Limpiar
                            </button>
                        </div>
                    </form>

                    <!-- Spinner de carga -->
                    <div class="text-center mt-4 loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Procesando...</span>
                        </div>
                        <p class="mt-2">Procesando archivo, por favor espere...</p>
                    </div>

                    <!-- Área de resultados -->
                    <div id="resultadosProcesamiento" class="mt-4 hidden">
                        <!-- Los resultados se cargarán aquí dinámicamente -->
                    </div>

                    <!-- Card de éxito con KPIs y acciones -->
                    <div id="successCard" class="success-card mt-4">
                        <div class="success-header">
                            <div class="d-flex align-items-center">
                                <div class="success-icon me-3">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">¡Archivo procesado exitosamente!</h5>
                                    <p class="mb-0 text-muted">Los datos han sido validados y están listos para análisis</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="success-body">
                            <!-- KPIs del archivo procesado -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-3">
                                    <div class="success-kpi">
                                        <div class="kpi-number" id="totalRegistros">0</div>
                                        <div class="kpi-label">Registros</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="success-kpi">
                                        <div class="kpi-number" id="totalColumnas">0</div>
                                        <div class="kpi-label">Columnas</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="success-kpi">
                                        <div class="kpi-number" id="registrosValidos">0</div>
                                        <div class="kpi-label">Válidos</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="success-kpi">
                                        <div class="kpi-number" id="tamanioArchivo">0</div>
                                        <div class="kpi-label">Tamaño</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Botones de acción -->
                            <div class="success-actions">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <a href="{{ url_for('ver_analisis') }}" class="btn btn-primary w-100">
                                            <i class="fas fa-chart-line me-2"></i>Ver Análisis
                                        </a>
                                    </div>
                                    <div class="col-md-4">
                                        <a href="{{ url_for('generar_informe') }}" class="btn btn-outline-primary w-100">
                                            <i class="fas fa-file-pdf me-2"></i>Generar Informe
                                        </a>
                                    </div>
                                    <div class="col-md-4">
                                        <a href="{{ url_for('mapa_intervenciones') }}" class="btn btn-outline-primary w-100">
                                            <i class="fas fa-map-marked-alt me-2"></i>Ver Mapa
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel colapsable con información del formato esperado -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="accordion custom-accordion" id="formatInfoAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFormat">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFormat" aria-expanded="false" aria-controls="collapseFormat">
                            <i class="fas fa-info-circle me-2"></i>
                            Información del Formato Esperado
                        </button>
                    </h2>
                    <div id="collapseFormat" class="accordion-collapse collapse" aria-labelledby="headingFormat" data-bs-parent="#formatInfoAccordion">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-check-circle text-success"></i> Columnas Requeridas:</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-caret-right text-primary me-1"></i>
                                            <strong>Shape:</strong> Tipo de geometría
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-caret-right text-primary me-1"></i>
                                            <strong>X, Y:</strong> Coordenadas geográficas
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-caret-right text-primary me-1"></i>
                                            <strong>id_punto:</strong> Identificador único
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-caret-right text-primary me-1"></i>
                                            <strong>estado_obr:</strong> Estado de la obra
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-caret-right text-primary me-1"></i>
                                            <strong>fecha_dilig:</strong> Fecha de diligenciamiento
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-users text-primary"></i> Datos de Personal:</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-caret-right text-primary me-1"></i>
                                            <strong>num_cuadri:</strong> Número de cuadrillas
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-caret-right text-primary me-1"></i>
                                            <strong>cant_ayuda, cant_ofici:</strong> Tipos de trabajadores
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-caret-right text-primary me-1"></i>
                                            <strong>total_hora:</strong> Horas trabajadas
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-caret-right text-primary me-1"></i>
                                            <strong>horas_retr, horas_mini:</strong> Horas de maquinaria
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning mt-3" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Importante:</strong> Asegúrese de que el archivo proviene directamente de Survey123 y mantiene la estructura original de columnas.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de archivos procesados -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="history-card">
                <div class="history-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Historial de Archivos Procesados
                    </h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="limpiarHistorial()">
                        <i class="fas fa-trash me-1"></i>Limpiar Historial
                    </button>
                </div>
                <div class="history-body">
                    <div id="historialArchivos">
                        <!-- Tabla de historial -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="tablaHistorial">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-file me-1"></i>Nombre</th>
                                        <th><i class="fas fa-calendar me-1"></i>Fecha</th>
                                        <th><i class="fas fa-list-ol me-1"></i>Registros</th>
                                        <th><i class="fas fa-database me-1"></i>Tamaño</th>
                                        <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historialBody">
                                    <tr class="empty-state">
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <p class="mb-0">No hay archivos procesados en esta sesión</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Funciones auxiliares para manejo de visibilidad
function showElement(id) {
    const element = document.getElementById(id);
    element.classList.remove('hidden');
    element.classList.add('show');
}

function hideElement(id) {
    const element = document.getElementById(id);
    element.classList.remove('show');
    element.classList.add('hidden');
}

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const archivo = document.getElementById('archivo').files[0];
    
    if (!archivo) {
        mostrarAlerta('Por favor seleccione un archivo', 'warning');
        return;
    }
    
    // Validar tamaño del archivo (16MB)
    if (archivo.size > 16 * 1024 * 1024) {
        mostrarAlerta('El archivo es demasiado grande. Máximo 16MB permitido.', 'danger');
        return;
    }
    
    formData.append('archivo', archivo);
    
    // Mostrar spinner
    showElement('loadingSpinner');
    document.getElementById('btnProcesar').disabled = true;
    hideElement('resultadosProcesamiento');
    
    fetch('/procesar_archivo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Ocultar spinner
        hideElement('loadingSpinner');
        document.getElementById('btnProcesar').disabled = false;
        
        if (data.exito) {
            mostrarResultadosExito(data);
            
            // Agregar al historial
            const nombreArchivo = archivo.name;
            const tamaño = formatFileSize(archivo.size);
            const registros = data.resumen?.archivo_procesado?.filas || 0;
            agregarAlHistorial(nombreArchivo, registros, tamaño);
        } else {
            mostrarResultadosError(data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideElement('loadingSpinner');
        document.getElementById('btnProcesar').disabled = false;
        mostrarAlerta('Error procesando el archivo. Intente nuevamente.', 'danger');
    });
});

function mostrarResultadosExito(data) {
    const resultadosDiv = document.getElementById('resultadosProcesamiento');
    const resumen = data.resumen || {};
    const archivo = resumen.archivo_procesado || {};
    const validacion = resumen.validacion || {};
    const estadisticas = resumen.estadisticas || {};
    
    resultadosDiv.innerHTML = `
        <div class="alert alert-success" role="alert">
            <h5><i class="fas fa-check-circle"></i> ¡Archivo Procesado Exitosamente!</h5>
            <p class="mb-0">${data.mensaje || 'Archivo procesado correctamente'}</p>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6><i class="fas fa-database"></i> Estadísticas del Archivo</h6>
                        <p class="mb-1">📊 Registros: ${archivo.filas || 0}</p>
                        <p class="mb-1">📋 Columnas: ${archivo.columnas || 0}</p>
                        <p class="mb-0">✅ Válido: ${validacion.es_valido ? 'Sí' : 'No'}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6><i class="fas fa-chart-bar"></i> KPIs Principales</h6>
                        <p class="mb-1">👥 Trabajadores: ${estadisticas.total_trabajadores || 0}</p>
                        <p class="mb-1">⏰ Horas: ${estadisticas.total_horas || 0}</p>
                        <p class="mb-0">🏗️ Intervenciones: ${estadisticas.total_intervenciones || 0}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-3">
            <div class="btn-group" role="group">
                <a href="/ver_analisis" class="btn btn-primary">
                    <i class="fas fa-chart-line"></i> Ver Análisis Completo
                </a>
                <a href="/generar_informe" class="btn btn-success">
                    <i class="fas fa-file-pdf"></i> Generar Informe
                </a>
                <a href="/mapa_intervenciones" class="btn btn-info">
                    <i class="fas fa-map-marked-alt"></i> Ver Mapa
                </a>
            </div>
        </div>
    `;
    
    showElement('resultadosProcesamiento');
    
    // Scroll a los resultados
    resultadosDiv.scrollIntoView({ behavior: 'smooth' });
}

function mostrarResultadosError(data) {
    const resultadosDiv = document.getElementById('resultadosProcesamiento');
    
    let detallesError = '';
    if (data.errores && Array.isArray(data.errores)) {
        detallesError = '<ul class="mb-0">';
        data.errores.forEach(error => {
            detallesError += `<li>${error}</li>`;
        });
        detallesError += '</ul>';
    } else if (data.detalles) {
        detallesError = `<p class="mb-0">${JSON.stringify(data.detalles)}</p>`;
    }
    
    resultadosDiv.innerHTML = `
        <div class="alert alert-danger" role="alert">
            <h5><i class="fas fa-exclamation-circle"></i> Error Procesando Archivo</h5>
            <p><strong>Mensaje:</strong> ${data.error || 'Error desconocido'}</p>
            ${detallesError}
        </div>
        
        <div class="card border-warning">
            <div class="card-header bg-warning">
                <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Sugerencias</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Verifique que el archivo sea un Excel válido (.xlsx o .xls)</li>
                    <li>Asegúrese de que el archivo proviene de Survey123</li>
                    <li>Revise que las columnas requeridas estén presentes</li>
                    <li>Verifique que no hay caracteres especiales en los nombres de columnas</li>
                </ul>
            </div>
        </div>
    `;
    
    showElement('resultadosProcesamiento');
    resultadosDiv.scrollIntoView({ behavior: 'smooth' });
}

function limpiarFormulario() {
    document.getElementById('uploadForm').reset();
    hideElement('resultadosProcesamiento');
    hideElement('loadingSpinner');
    document.getElementById('btnProcesar').disabled = false;
}

// Drag and drop functionality
const fileInput = document.getElementById('archivo');
const dropZone = document.getElementById('dropzone');

// Click en dropzone para abrir selector de archivos
dropZone.addEventListener('click', function() {
    fileInput.click();
});

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    dropZone.classList.add('dropzone-active');
}

function unhighlight(e) {
    dropZone.classList.remove('dropzone-active');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        fileInput.files = files;
        
        // Trigger change event
        const event = new Event('change', { bubbles: true });
        fileInput.dispatchEvent(event);
    }
}

// Mostrar archivo seleccionado
fileInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
        const file = this.files[0];
        const fileName = file.name;
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        
        // Mostrar información del archivo
        document.querySelector('#selectedFile .file-name').textContent = fileName;
        document.querySelector('#selectedFile .file-size').textContent = `${fileSize} MB`;
        
        // Mostrar elementos
        document.getElementById('selectedFile').classList.remove('selected-file-hidden');
        document.getElementById('uploadForm').classList.remove('upload-form-hidden');
        
        // Ocultar dropzone
        dropZone.style.display = 'none';
        
        mostrarAlerta(`Archivo seleccionado: ${fileName} (${fileSize} MB)`, 'success');
    }
});

// Función para eliminar archivo seleccionado
function removeFile() {
    fileInput.value = '';
    document.getElementById('selectedFile').classList.add('selected-file-hidden');
    document.getElementById('uploadForm').classList.add('upload-form-hidden');
    dropZone.style.display = 'block';
}

// Funciones del historial de archivos
function agregarAlHistorial(nombreArchivo, registros, tamaño) {
    const historial = JSON.parse(localStorage.getItem('historialArchivos')) || [];
    
    const nuevoArchivo = {
        id: Date.now(),
        nombre: nombreArchivo,
        fecha: new Date().toLocaleString('es-ES'),
        registros: registros || 0,
        tamaño: tamaño || '0 MB',
        timestamp: Date.now()
    };
    
    historial.unshift(nuevoArchivo);
    
    // Mantener solo los últimos 10 archivos
    if (historial.length > 10) {
        historial.splice(10);
    }
    
    localStorage.setItem('historialArchivos', JSON.stringify(historial));
    actualizarTablaHistorial();
}

function actualizarTablaHistorial() {
    const historial = JSON.parse(localStorage.getItem('historialArchivos')) || [];
    const tbody = document.getElementById('historialBody');
    
    if (historial.length === 0) {
        tbody.innerHTML = `
            <tr class="empty-state">
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">No hay archivos procesados en esta sesión</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = historial.map(archivo => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-file-excel text-success me-2"></i>
                    <span class="fw-semibold">${archivo.nombre}</span>
                </div>
            </td>
            <td class="text-muted">${archivo.fecha}</td>
            <td>
                <span class="badge bg-primary">${archivo.registros}</span>
            </td>
            <td class="text-muted">${archivo.tamaño}</td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="verDetalles(${archivo.id})" title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="eliminarDelHistorial(${archivo.id})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function eliminarDelHistorial(id) {
    if (confirm('¿Está seguro de que desea eliminar este archivo del historial?')) {
        const historial = JSON.parse(localStorage.getItem('historialArchivos')) || [];
        const nuevoHistorial = historial.filter(archivo => archivo.id !== id);
        localStorage.setItem('historialArchivos', JSON.stringify(nuevoHistorial));
        actualizarTablaHistorial();
        mostrarAlerta('Archivo eliminado del historial', 'success');
    }
}

function verDetalles(id) {
    const historial = JSON.parse(localStorage.getItem('historialArchivos')) || [];
    const archivo = historial.find(a => a.id === id);
    
    if (archivo) {
        mostrarAlerta(`Archivo: ${archivo.nombre} - Procesado el ${archivo.fecha} con ${archivo.registros} registros`, 'info');
    }
}

function limpiarHistorial() {
    if (confirm('¿Está seguro de que desea limpiar todo el historial?')) {
        localStorage.removeItem('historialArchivos');
        actualizarTablaHistorial();
        mostrarAlerta('Historial limpiado correctamente', 'success');
    }
}

// Cargar historial al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    actualizarTablaHistorial();
});
</script>
{% endblock %}
