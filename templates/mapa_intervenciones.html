{% extends "base.html" %}

{% block title %}Mapa de Intervenciones - Sistema de Informes Survey123{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .map-container {
        height: 600px;
        border-radius: 15px;
    }
    .hidden-panel {
        display: none;
    }
    .sidebar-panel {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }
    .sidebar-header {
        background: var(--primary-color);
        color: white;
        padding: 15px 20px;
        font-weight: 600;
    }
    .sidebar-body {
        padding: 20px;
    }
    .map-panel {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .map-header {
        background: var(--primary-color);
        color: white;
        padding: 15px 20px;
    }
    .map-body {
        padding: 0;
    }
    .stat-mini {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid var(--primary-color);
    }
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .filter-group {
        margin-bottom: 15px;
    }
    .filter-actions {
        margin-top: 20px;
    }
    .legend-items {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .legend-color.terminada { background-color: #28a745; }
    .legend-color.en-ejecucion { background-color: #007bff; }
    .legend-color.pendiente { background-color: #dc3545; }
    .legend-color.suspendida { background-color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="page-title">
                <i class="fas fa-map-marked-alt me-3"></i>
                Mapa de Intervenciones Urbanas
            </h2>
            <p class="page-subtitle">
                Visualización geográfica interactiva de las intervenciones de infraestructura
            </p>
        </div>
    </div>

    <!-- Layout principal: 2/3 mapa + 1/3 barra lateral -->
    <div class="row">
        <!-- Mapa principal (2/3) -->
        <div class="col-lg-8">
            <div class="map-panel">
                <div class="map-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-globe me-2"></i>Vista Interactiva
                        </h5>
                        <div class="map-controls">
                            <button class="btn btn-outline-light btn-sm me-2" onclick="centrarMapa()">
                                <i class="fas fa-crosshairs me-1"></i>Centrar
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="exportarMapa()">
                                <i class="fas fa-download me-1"></i>Exportar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="map-body">
                    <div id="map" class="map-container"></div>
                </div>
            </div>
        </div>

        <!-- Barra lateral (1/3) -->
        <div class="col-lg-4">
            <!-- Estadísticas rápidas -->
            <div class="sidebar-panel">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Estadísticas Rápidas
                    </h6>
                </div>
                <div class="sidebar-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="stat-mini">
                                <div class="stat-value">{{ total_intervenciones or 0 }}</div>
                                <div class="stat-label">Total</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-mini">
                                <div class="stat-value">{{ terminadas or 0 }}</div>
                                <div class="stat-label">Terminadas</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-mini">
                                <div class="stat-value">{{ en_ejecucion or 0 }}</div>
                                <div class="stat-label">En Ejecución</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-mini">
                                <div class="stat-value">{{ pendientes or 0 }}</div>
                                <div class="stat-label">Pendientes</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Total Puntos:</small>
                            <small class="fw-bold" id="totalPuntos">0</small>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Visibles:</small>
                            <small class="fw-bold" id="puntosVisibles">0</small>
                        </div>
                    </div>
                    <div id="estadisticasDetalle" class="mt-3">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="sidebar-panel">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtros
                    </h6>
                </div>
                <div class="sidebar-body">
                    <!-- Estado -->
                    <div class="filter-group">
                        <label for="filtroEstado" class="form-label">Estado</label>
                        <select class="form-select form-select-sm" id="filtroEstado" onchange="aplicarFiltroMapa()">
                            <option value="">Todos los estados</option>
                            <option value="Terminada">Terminada</option>
                            <option value="En ejecucion">En Ejecución</option>
                            <option value="En proceso">En proceso</option>
                            <option value="Pendiente">Pendiente</option>
                        </select>
                    </div>

                    <!-- Intervenor -->
                    <div class="filter-group">
                        <label for="filtroInterventor" class="form-label">Intervenor</label>
                        <select class="form-select form-select-sm" id="filtroInterventor" onchange="aplicarFiltroMapa()">
                            <option value="">Todos los interventores</option>
                        </select>
                    </div>

                    <!-- Tipo de visualización -->
                    <div class="filter-group">
                        <label for="tipoVisualizacion" class="form-label">Visualización</label>
                        <select class="form-select form-select-sm" id="tipoVisualizacion" onchange="cambiarVisualizacion()">
                            <option value="markers">Marcadores</option>
                            <option value="heatmap">Mapa de Calor</option>
                            <option value="clusters">Agrupaciones</option>
                        </select>
                    </div>

                    <div class="filter-actions">
                        <button class="btn btn-primary btn-sm w-100 mb-2" onclick="aplicarFiltroMapa()">
                            <i class="fas fa-search me-1"></i>Aplicar
                        </button>
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="limpiarFiltrosMapa()">
                            <i class="fas fa-times me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Leyenda -->
            <div class="sidebar-panel">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-map-signs me-2"></i>Leyenda
                    </h6>
                </div>
                <div class="sidebar-body">
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color terminada"></div>
                            <span>Terminada</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color en-ejecucion"></div>
                            <span>En Ejecución</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color pendiente"></div>
                            <span>Pendiente</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color suspendida"></div>
                            <span>Suspendida</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información del punto seleccionado -->
            <div class="sidebar-panel hidden-panel" id="infoPunto">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>Información Detallada
                    </h6>
                </div>
                <div class="sidebar-body" id="contenidoInfoPunto">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Variables globales
let mapa;
let grupoMarcadores;
let datosPuntos = [];
let interventoresCargados = [];

// Configuración inicial
const configMapa = {
    centro: [6.2442, -75.5812], // Medellín
    zoom: 12,
    maxZoom: 18
};

// Colores por estado
const coloresPorEstado = {
    'Terminada': '#28a745',
    'En ejecucion': '#007bff',
    'En proceso': '#ffc107',
    'Pendiente': '#dc3545'
};

// Funciones auxiliares para manejo de paneles
function showPanel(id) {
    const element = document.getElementById(id);
    if (element) element.classList.remove('hidden-panel');
}

function hidePanel(id) {
    const element = document.getElementById(id);
    if (element) element.classList.add('hidden-panel');
}

// Inicialización cuando se carga el DOM
document.addEventListener('DOMContentLoaded', function() {
    inicializarMapa();
    cargarDatos();
});

// Inicializar el mapa base
function inicializarMapa() {
    mapa = L.map('map').setView(configMapa.centro, configMapa.zoom);
    
    // Capa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: configMapa.maxZoom
    }).addTo(mapa);
    
    // Grupo para los marcadores
    grupoMarcadores = L.layerGroup().addTo(mapa);
    
    // Eventos del mapa
    mapa.on('click', function(e) {
        ocultarInfoPunto();
    });
}

// Cargar datos de intervenciones
async function cargarDatos() {
    try {
        mostrarCarga(true);
        
        const response = await fetch('/api/datos_mapa');
        
        if (response.ok) {
            datosPuntos = await response.json();
            console.log('Datos cargados:', datosPuntos.length, 'puntos');
        } else {
            console.error('Error en la respuesta del servidor');
            datosPuntos = [];
        }
        
        // Cargar interventores únicos para el filtro
        cargarInterventores();
        
        actualizarMapa();
        actualizarEstadisticas();
        
    } catch (error) {
        console.error('Error cargando datos:', error);
        datosPuntos = [];
        actualizarMapa();
        actualizarEstadisticas();
    } finally {
        mostrarCarga(false);
    }
}

// Cargar lista de interventores para el filtro
function cargarInterventores() {
    const interventores = [...new Set(datosPuntos.map(p => p.nombre_interventor).filter(i => i))];
    const select = document.getElementById('filtroInterventor');
    
    // Limpiar opciones existentes (excepto la primera)
    select.innerHTML = '<option value="">Todos los interventores</option>';
    
    // Agregar interventores únicos
    interventores.forEach(interventor => {
        const option = document.createElement('option');
        option.value = interventor;
        option.textContent = interventor;
        select.appendChild(option);
    });
}

// Actualizar marcadores en el mapa
function actualizarMapa() {
    // Limpiar marcadores existentes
    grupoMarcadores.clearLayers();
    
    // Aplicar filtros
    const puntosFiltrados = aplicarFiltrosData();
    
    // Agregar nuevos marcadores
    puntosFiltrados.forEach(punto => {
        const marcador = crearMarcador(punto);
        grupoMarcadores.addLayer(marcador);
    });
    
    // Actualizar contadores
    document.getElementById('totalPuntos').textContent = datosPuntos.length;
    document.getElementById('puntosVisibles').textContent = puntosFiltrados.length;
}

// Crear marcador individual
function crearMarcador(punto) {
    const color = coloresPorEstado[punto.estado_obra] || '#6c757d';
    
    const marcador = L.circleMarker([punto.lat, punto.lng], {
        radius: 8,
        fillColor: color,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
    });
    
    // Popup con información básica
    const popupContent = `
        <div style="min-width: 200px;">
            <h6 class="mb-2">${punto.id_punto}</h6>
            <p class="mb-1"><strong>Estado:</strong> ${punto.estado_obra}</p>
            <p class="mb-1"><strong>Interventor:</strong> ${punto.nombre_interventor}</p>
            <p class="mb-1"><strong>Trabajadores:</strong> ${punto.total_trabajadores}</p>
            <p class="mb-0"><strong>Horas:</strong> ${punto.total_horas}</p>
        </div>
    `;
    
    marcador.bindPopup(popupContent);
    
    // Evento click para mostrar información detallada
    marcador.on('click', function() {
        mostrarInfoPunto(punto);
    });
    
    return marcador;
}

// Aplicar filtros a los datos
function aplicarFiltrosData() {
    const filtroEstado = document.getElementById('filtroEstado').value;
    const filtroInterventor = document.getElementById('filtroInterventor').value;
    
    return datosPuntos.filter(punto => {
        // Filtro por estado
        if (filtroEstado && punto.estado_obra !== filtroEstado) {
            return false;
        }
        
        // Filtro por interventor
        if (filtroInterventor && punto.nombre_interventor !== filtroInterventor) {
            return false;
        }
        
        return true;
    });
}

// Actualizar estadísticas del panel lateral
function actualizarEstadisticas() {
    const puntosFiltrados = aplicarFiltrosData();
    
    if (puntosFiltrados.length === 0) {
        document.getElementById('estadisticasDetalle').innerHTML = 
            '<small class="text-muted">No hay datos con los filtros seleccionados</small>';
        return;
    }
    
    // Calcular estadísticas
    const estadisticas = {
        totalTrabajadores: puntosFiltrados.reduce((sum, p) => sum + (p.total_trabajadores || 0), 0),
        totalHoras: puntosFiltrados.reduce((sum, p) => sum + (p.total_horas || 0), 0),
        estadosUnicos: [...new Set(puntosFiltrados.map(p => p.estado_obra))].length,
        interventoresUnicos: [...new Set(puntosFiltrados.map(p => p.nombre_interventor))].length
    };
    
    document.getElementById('estadisticasDetalle').innerHTML = `
        <div class="row g-2">
            <div class="col-6">
                <small class="text-muted">Trabajadores:</small>
                <div class="fw-bold">${estadisticas.totalTrabajadores.toLocaleString()}</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Horas total:</small>
                <div class="fw-bold">${estadisticas.totalHoras.toLocaleString()}</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Estados:</small>
                <div class="fw-bold">${estadisticas.estadosUnicos}</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Interventores:</small>
                <div class="fw-bold">${estadisticas.interventoresUnicos}</div>
            </div>
        </div>
    `;
}

// Mostrar información detallada de un punto
function mostrarInfoPunto(punto) {
    const contenido = document.getElementById('contenidoInfoPunto');
    
    contenido.innerHTML = `
        <h6 class="text-primary">${punto.id_punto}</h6>
        <hr>
        <p><strong>Estado:</strong> 
            <span class="badge" style="background-color: ${coloresPorEstado[punto.estado_obra]}">${punto.estado_obra}</span>
        </p>
        <p><strong>Interventor:</strong> ${punto.nombre_interventor}</p>
        <p><strong>Fecha:</strong> ${punto.fecha_diligenciamiento}</p>
        <p><strong>Trabajadores:</strong> ${punto.total_trabajadores}</p>
        <p><strong>Horas:</strong> ${punto.total_horas}</p>
        <p><strong>Coordenadas:</strong> ${punto.lat.toFixed(6)}, ${punto.lng.toFixed(6)}</p>
    `;
    
    showPanel('infoPunto');
}

// Ocultar información del punto
function ocultarInfoPunto() {
    hidePanel('infoPunto');
}

// Funciones de filtros
function aplicarFiltroMapa() {
    actualizarMapa();
    actualizarEstadisticas();
}

function limpiarFiltrosMapa() {
    document.getElementById('filtroEstado').value = '';
    document.getElementById('filtroInterventor').value = '';
    aplicarFiltroMapa();
}

// Función de centrar mapa
function centrarMapa() {
    if (datosPuntos.length > 0) {
        const bounds = L.latLngBounds(datosPuntos.map(p => [p.lat, p.lng]));
        mapa.fitBounds(bounds, { padding: [20, 20] });
    } else {
        mapa.setView(configMapa.centro, configMapa.zoom);
    }
}

// Función de cambiar visualización (placeholder)
function cambiarVisualizacion() {
    const tipo = document.getElementById('tipoVisualizacion').value;
    console.log('Cambiar visualización a:', tipo);
    // TODO: Implementar diferentes tipos de visualización
}

// Función de exportar (placeholder)
function exportarMapa() {
    console.log('Exportar mapa');
    // TODO: Implementar exportación
}

// Función para mostrar/ocultar carga
function mostrarCarga(mostrar) {
    // Simple indicador de carga en consola
    if (mostrar) {
        console.log('Cargando datos del mapa...');
    } else {
        console.log('Carga completada.');
    }
}
</script>
{% endblock %}
