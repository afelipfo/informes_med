{% extends "base.html" %}

{% block title %}Mapa de Intervenciones - Sistema de Informes Survey123{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .map-container {
        height: 600px;
        border-radius: 15px;
    }
    .hidden-panel {
        display: none;
    }
    .hidden-section {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="page-title">
                <i class="fas fa-map-marked-alt me-3"></i>
                Mapa de Intervenciones Urbanas
            </h2>
            <p class="page-subtitle">
                Visualización geográfica interactiva de las intervenciones de infraestructura
            </p>
        </div>
    </div>

    <!-- Layout principal: 2/3 mapa + 1/3 barra lateral -->
    <div class="row">
        <!-- Mapa principal (2/3) -->
        <div class="col-lg-8">
            <div class="map-panel">
                <div class="map-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-globe me-2"></i>Vista Interactiva
                        </h5>
                        <div class="map-controls">
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="toggleVistaLista()">
                                <i class="fas fa-list me-1"></i>Vista Lista
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="configurarVista()">
                                <i class="fas fa-cog me-1"></i>Configurar Vista
                            </button>
                        </div>
                    </div>
                </div>
                <div class="map-body">
                    <div id="map" class="map-container"></div>
                </div>
            </div>
        </div>

        <!-- Barra lateral (1/3) -->
        <div class="col-lg-4">
            <!-- Estadísticas rápidas -->
            <div class="sidebar-panel mb-4">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Estadísticas Rápidas
                    </h6>
                </div>
                <div class="sidebar-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="stat-mini">
                                <div class="stat-value">{{ total_intervenciones or 0 }}</div>
                                <div class="stat-label">Total</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-mini">
                                <div class="stat-value">{{ terminadas or 0 }}</div>
                                <div class="stat-label">Terminadas</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-mini">
                                <div class="stat-value">{{ en_ejecucion or 0 }}</div>
                                <div class="stat-label">En Ejecución</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-mini">
                                <div class="stat-value">{{ pendientes or 0 }}</div>
                                <div class="stat-label">Pendientes</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="sidebar-panel mb-4">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtros
                    </h6>
                </div>
                <div class="sidebar-body">
                    <!-- Estado -->
                    <div class="filter-group">
                        <label for="filtroEstado" class="form-label">Estado</label>
                        <select class="form-select form-select-sm" id="filtroEstado" onchange="aplicarFiltroMapa()">
                            <option value="">Todos los estados</option>
                            <option value="terminado">Terminado</option>
                            <option value="en_ejecucion">En Ejecución</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="suspendido">Suspendido</option>
                        </select>
                    </div>

                    <!-- Intervenor -->
                    <div class="filter-group">
                        <label for="filtroIntervenor" class="form-label">Intervenor</label>
                        <select class="form-select form-select-sm" id="filtroIntervenor" onchange="aplicarFiltroMapa()">
                            <option value="">Todos los interventores</option>
                        </select>
                    </div>

                    <!-- Tipo de visualización -->
                    <div class="filter-group">
                        <label for="tipoVisualizacion" class="form-label">Visualización</label>
                        <select class="form-select form-select-sm" id="tipoVisualizacion" onchange="cambiarVisualizacion()">
                            <option value="markers">Marcadores</option>
                            <option value="heatmap">Mapa de Calor</option>
                            <option value="clusters">Agrupaciones</option>
                        </select>
                    </div>

                    <div class="filter-actions">
                        <button class="btn btn-primary btn-sm w-100 mb-2" onclick="aplicarFiltroMapa()">
                            <i class="fas fa-search me-1"></i>Aplicar
                        </button>
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="limpiarFiltrosMapa()">
                            <i class="fas fa-times me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Leyenda -->
            <div class="sidebar-panel">
                <div class="sidebar-header">
                    <h6 class="mb-0">
                        <i class="fas fa-map-signs me-2"></i>Leyenda
                    </h6>
                </div>
                <div class="sidebar-body">
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color terminada"></div>
                            <span>Terminada</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color en-ejecucion"></div>
                            <span>En Ejecución</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color pendiente"></div>
                            <span>Pendiente</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color suspendida"></div>
                            <span>Suspendida</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botón de exportar -->
            <div class="text-center mt-4">
                <button class="btn btn-outline-primary w-100" onclick="exportarMapa()">
                    <i class="fas fa-download me-2"></i>Exportar Datos
                </button>
            </div>
        </div>
    </div>
                                Configurar Vista
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="exportarMapa()">
                                <i class="fas fa-download"></i>
                                Exportar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body" id="panelFiltros">
                    <div class="row">
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtroEstado" onchange="aplicarFiltros()" title="Filtrar por estado de la obra">
                                <option value="">Todos los estados</option>
                                <option value="En ejecucion">En ejecución</option>
                                <option value="Terminada">Terminada</option>
                                <option value="En proceso">En proceso</option>
                                <option value="Pendiente">Pendiente</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtroComuna" onchange="aplicarFiltros()" title="Filtrar por interventor">
                                <option value="">Todos los interventores</option>
                                <!-- Opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="tipoVisualizacion" onchange="cambiarVisualizacion()" title="Tipo de visualización del mapa">
                                <option value="puntos">Puntos individuales</option>
                                <option value="cluster">Agrupación (cluster)</option>
                                <option value="heatmap">Mapa de calor</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="centrarMapa()" title="Centrar mapa">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleLeyenda()" title="Mostrar/ocultar leyenda">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="verEstadisticas()" title="Ver estadísticas">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor principal del mapa -->
    <div class="row">
        <!-- Mapa -->
        <div class="col-lg-9">
            <div class="card">
                <div class="card-body p-0">
                    <div id="mapa" class="map-container"></div>
                </div>
            </div>
        </div>

        <!-- Panel lateral con información -->
        <div class="col-lg-3">
            <!-- Estadísticas rápidas -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle text-primary"></i>
                        Estadísticas Rápidas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <div class="border-end">
                                <h4 class="text-primary mb-0" id="totalPuntos">0</h4>
                                <small class="text-muted">Total Puntos</small>
                            </div>
                        </div>
                        <div class="col-6 mb-2">
                            <h4 class="text-success mb-0" id="puntosVisibles">0</h4>
                            <small class="text-muted">Visibles</small>
                        </div>
                    </div>
                    <hr>
                    <div id="estadisticasDetalle">
                        <small class="text-muted">Seleccione filtros para ver estadísticas detalladas</small>
                    </div>
                </div>
            </div>

            <!-- Leyenda -->
            <div class="card mb-3" id="leyendaCard">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-map-pin text-primary"></i>
                        Leyenda
                    </h6>
                </div>
                <div class="card-body">
                    <div class="leyenda-item mb-2">
                        <span class="badge bg-success me-2">●</span>
                        <small>Terminada</small>
                    </div>
                    <div class="leyenda-item mb-2">
                        <span class="badge bg-primary me-2">●</span>
                        <small>En ejecución</small>
                    </div>
                    <div class="leyenda-item mb-2">
                        <span class="badge bg-warning me-2">●</span>
                        <small>En proceso</small>
                    </div>
                    <div class="leyenda-item mb-2">
                        <span class="badge bg-danger me-2">●</span>
                        <small>Pendiente</small>
                    </div>
                </div>
            </div>

            <!-- Información del punto seleccionado -->
            <div class="card hidden-panel" id="infoPunto">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-map-marker-alt text-primary"></i>
                        Información Detallada
                    </h6>
                </div>
                <div class="card-body" id="contenidoInfoPunto">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>

            <!-- Lista de puntos cercanos -->
            <div class="card mt-3 hidden-panel" id="puntosCercanos">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-location-arrow text-primary"></i>
                        Puntos Cercanos
                    </h6>
                </div>
                <div class="card-body" id="listaPuntosCercanos">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para configuración avanzada -->
    <div class="modal fade" id="modalConfiguracion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cog"></i>
                        Configuración Avanzada del Mapa
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" title="Cerrar configuración"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Capas del Mapa</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="capaInterventions" checked>
                                <label class="form-check-label" for="capaInterventions">
                                    Intervenciones
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="capaComunas">
                                <label class="form-check-label" for="capaComunas">
                                    Límites de Comunas
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="capaBarrios">
                                <label class="form-check-label" for="capaBarrios">
                                    Límites de Barrios
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Estilo del Mapa Base</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="estiloMapa" id="estiloOSM" value="osm" checked>
                                <label class="form-check-label" for="estiloOSM">
                                    OpenStreetMap
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="estiloMapa" id="estiloSatelite" value="satelite">
                                <label class="form-check-label" for="estiloSatelite">
                                    Vista Satelital
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="estiloMapa" id="estiloTerrain" value="terrain">
                                <label class="form-check-label" for="estiloTerrain">
                                    Relieve
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="aplicarConfiguracion()">Aplicar Cambios</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let mapa;
let grupoMarcadores;
let datosPuntos = [];
let modalConfiguracion;

// Configuración inicial
const configMapa = {
    centro: [6.2442, -75.5812], // Medellín
    zoom: 12,
    maxZoom: 18
};

// Colores por estado
const coloresPorEstado = {
    'Terminada': '#28a745',
    'En ejecucion': '#007bff',
    'En proceso': '#ffc107',
    'Pendiente': '#dc3545'
};

// Funciones auxiliares para manejo de paneles
function showPanel(id) {
    const element = document.getElementById(id);
    element.classList.remove('hidden-panel');
}

function hidePanel(id) {
    const element = document.getElementById(id);
    element.classList.add('hidden-panel');
}

// Inicialización cuando se carga el DOM
document.addEventListener('DOMContentLoaded', function() {
    inicializarMapa();
    cargarDatos();
    modalConfiguracion = new bootstrap.Modal(document.getElementById('modalConfiguracion'));
});

// Inicializar el mapa base
function inicializarMapa() {
    mapa = L.map('mapa').setView(configMapa.centro, configMapa.zoom);
    
    // Capa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: configMapa.maxZoom
    }).addTo(mapa);
    
    // Grupo para los marcadores
    grupoMarcadores = L.layerGroup().addTo(mapa);
    
    // Eventos del mapa
    mapa.on('click', function(e) {
        ocultarInfoPunto();
    });
}

// Cargar datos de intervenciones
async function cargarDatos() {
    try {
        mostrarCarga(true);
        
        // Simular carga de datos - en implementación real sería una llamada a la API
        const response = await fetch('/api/datos_mapa');
        
        if (response.ok) {
            datosPuntos = await response.json();
        } else {
            // Datos de prueba si no hay API
            datosPuntos = generarDatosPrueba();
        }
        
        actualizarMapa();
        actualizarEstadisticas();
        
    } catch (error) {
        console.error('Error cargando datos:', error);
        datosPuntos = generarDatosPrueba();
        actualizarMapa();
        actualizarEstadisticas();
    } finally {
        mostrarCarga(false);
    }
}

// Generar datos de prueba
function generarDatosPrueba() {
    const estados = ['Terminada', 'En ejecucion', 'En proceso', 'Pendiente'];
    const datos = [];
    
    for (let i = 0; i < 50; i++) {
        // Coordenadas aleatorias en el área de Medellín
        const lat = 6.2442 + (Math.random() - 0.5) * 0.2;
        const lng = -75.5812 + (Math.random() - 0.5) * 0.3;
        
        datos.push({
            id: i + 1,
            lat: lat,
            lng: lng,
            estado: estados[Math.floor(Math.random() * estados.length)],
            comuna: Math.floor(Math.random() * 10) + 1,
            tipo_trabajo: 'Mantenimiento vial',
            trabajadores: Math.floor(Math.random() * 20) + 1,
            horas: Math.floor(Math.random() * 100) + 10,
            fecha: '2025-09-08',
            descripcion: `Intervención ${i + 1} en infraestructura urbana`
        });
    }
    
    return datos;
}

// Actualizar marcadores en el mapa
function actualizarMapa() {
    // Limpiar marcadores existentes
    grupoMarcadores.clearLayers();
    
    // Aplicar filtros
    const puntosFiltrados = aplicarFiltrosData();
    
    // Agregar nuevos marcadores
    puntosFiltrados.forEach(punto => {
        const marcador = crearMarcador(punto);
        grupoMarcadores.addLayer(marcador);
    });
    
    // Actualizar contadores
    document.getElementById('totalPuntos').textContent = datosPuntos.length;
    document.getElementById('puntosVisibles').textContent = puntosFiltrados.length;
}

// Crear marcador individual
function crearMarcador(punto) {
    const color = coloresPorEstado[punto.estado_obra] || '#6c757d';
    
    const marcador = L.circleMarker([punto.lat, punto.lng], {
        radius: 8,
        fillColor: color,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
    });
    
    // Popup
    const popupContent = `
        <div class="popup-content">
            <h6><i class="fas fa-map-marker-alt"></i> ${punto.id_punto}</h6>
            <p class="mb-1"><strong>Estado:</strong> <span class="badge" style="background-color: ${color}">${punto.estado_obra}</span></p>
            <p class="mb-1"><strong>Interventor:</strong> ${punto.nombre_interventor}</p>
            <p class="mb-1"><strong>Trabajadores:</strong> ${punto.total_trabajadores}</p>
            <p class="mb-1"><strong>Horas:</strong> ${punto.total_horas}</p>
            <p class="mb-0"><small class="text-muted">Fecha: ${punto.fecha_diligenciamiento}</small></p>
        </div>
    `;
    
    marcador.bindPopup(popupContent);
    
    // Eventos
    marcador.on('click', function(e) {
        mostrarInfoPunto(punto);
        L.DomEvent.stopPropagation(e);
    });
    
    return marcador;
}

// Aplicar filtros a los datos
function aplicarFiltrosData() {
    const filtroEstado = document.getElementById('filtroEstado').value;
    const filtroInterventor = document.getElementById('filtroComuna').value; // Reutilizamos el campo para interventores
    
    return datosPuntos.filter(punto => {
        let pasa = true;
        
        if (filtroEstado && punto.estado_obra !== filtroEstado) {
            pasa = false;
        }
        
        if (filtroInterventor && punto.nombre_interventor !== filtroInterventor) {
            pasa = false;
        }
        
        return pasa;
    });
}

// Aplicar filtros (llamada desde UI)
function aplicarFiltros() {
    actualizarMapa();
    actualizarEstadisticas();
}

// Actualizar estadísticas del panel lateral
function actualizarEstadisticas() {
    const puntosFiltrados = aplicarFiltrosData();
    
    if (puntosFiltrados.length === 0) {
        document.getElementById('estadisticasDetalle').innerHTML = 
            '<small class="text-muted">No hay datos con los filtros seleccionados</small>';
        return;
    }
    
    // Calcular estadísticas
    const estadisticas = {
        totalTrabajadores: puntosFiltrados.reduce((sum, p) => sum + (p.total_trabajadores || 0), 0),
        totalHoras: puntosFiltrados.reduce((sum, p) => sum + (p.total_horas || 0), 0),
        estadosUnicos: [...new Set(puntosFiltrados.map(p => p.estado_obra))].length,
        interventoresUnicos: [...new Set(puntosFiltrados.map(p => p.nombre_interventor))].length
    };
    
    document.getElementById('estadisticasDetalle').innerHTML = `
        <div class="mb-2">
            <small class="text-muted">Trabajadores:</small>
            <div class="fw-bold">${estadisticas.totalTrabajadores.toLocaleString()}</div>
        </div>
        <div class="mb-2">
            <small class="text-muted">Horas total:</small>
            <div class="fw-bold">${estadisticas.totalHoras.toLocaleString()}</div>
        </div>
        <div class="mb-2">
            <small class="text-muted">Estados diferentes:</small>
            <div class="fw-bold">${estadisticas.estadosUnicos}</div>
        </div>
        <div>
            <small class="text-muted">Interventores:</small>
            <div class="fw-bold">${estadisticas.interventoresUnicos}</div>
        </div>
    `;
}

// Mostrar información detallada de un punto
function mostrarInfoPunto(punto) {
    const infoDiv = document.getElementById('infoPunto');
    const contenido = document.getElementById('contenidoInfoPunto');
    
    contenido.innerHTML = `
        <h6 class="text-primary">${punto.id_punto}</h6>
        <hr>
        <p><strong>Estado:</strong> 
            <span class="badge" style="background-color: ${coloresPorEstado[punto.estado_obra]}">${punto.estado_obra}</span>
        </p>
        <p><strong>Interventor:</strong> ${punto.nombre_interventor}</p>
        <p><strong>Trabajadores:</strong> ${punto.total_trabajadores}</p>
        <p><strong>Horas:</strong> ${punto.total_horas}</p>
        <p><strong>Fecha:</strong> ${punto.fecha_diligenciamiento}</p>
        <p><strong>Coordenadas:</strong><br>
            <small class="text-muted">Lat: ${punto.lat.toFixed(6)}<br>
            Lng: ${punto.lng.toFixed(6)}</small>
        </p>
        <div class="text-center mt-3">
            <button class="btn btn-outline-primary btn-sm" onclick="centrarEnPunto(${punto.lat}, ${punto.lng})">
                <i class="fas fa-crosshairs"></i> Centrar
            </button>
            <button class="btn btn-outline-info btn-sm" onclick="buscarCercanos('${punto.id_punto}')">
                <i class="fas fa-search"></i> Ver Cercanos
            </button>
        </div>
    `;
    
    infoDiv = document.getElementById('infoPunto');
    showPanel('infoPunto');
}

// Ocultar información del punto
function ocultarInfoPunto() {
    hidePanel('infoPunto');
    hidePanel('puntosCercanos');
}

// Centrar mapa en coordenadas específicas
function centrarEnPunto(lat, lng) {
    mapa.setView([lat, lng], 16);
}

// Centrar mapa en vista general
function centrarMapa() {
    mapa.setView(configMapa.centro, configMapa.zoom);
}

// Toggle leyenda
function toggleLeyenda() {
    const leyenda = document.getElementById('leyendaCard');
    leyenda.style.display = leyenda.style.display === 'none' ? 'block' : 'none';
}

// Toggle panel de filtros
function toggleFiltros() {
    modalConfiguracion.show();
}

// Ver estadísticas
function verEstadisticas() {
    window.open('/ver_analisis', '_blank');
}

// Cambiar tipo de visualización
function cambiarVisualizacion() {
    const tipo = document.getElementById('tipoVisualizacion').value;
    // Implementar diferentes tipos de visualización
    console.log('Cambiar visualización a:', tipo);
}

// Exportar mapa
function exportarMapa() {
    // Implementar exportación del mapa
    alert('Funcionalidad de exportación en desarrollo');
}

// Buscar puntos cercanos
function buscarCercanos(puntoId) {
    const punto = datosPuntos.find(p => p.id_punto === puntoId);
    if (!punto) return;
    
    // Calcular distancias (simplificado)
    const cercanos = datosPuntos
        .filter(p => p.id_punto !== puntoId)
        .map(p => ({
            ...p,
            distancia: calcularDistancia(punto.lat, punto.lng, p.lat, p.lng)
        }))
        .filter(p => p.distancia < 1) // Menos de 1 km
        .sort((a, b) => a.distancia - b.distancia)
        .slice(0, 5);
    
    if (cercanos.length === 0) {
        document.getElementById('listaPuntosCercanos').innerHTML = 
            '<small class="text-muted">No hay puntos cercanos en un radio de 1 km</small>';
    } else {
        const html = cercanos.map(p => `
            <div class="border-bottom py-2">
                <div class="d-flex justify-content-between">
                    <span><strong>${p.id_punto}</strong></span>
                    <small class="text-muted">${(p.distancia * 1000).toFixed(0)}m</small>
                </div>
                <small class="text-muted">${p.estado_obra} - ${p.nombre_interventor}</small>
            </div>
        `).join('');
        
        document.getElementById('listaPuntosCercanos').innerHTML = html;
    }
    
    showPanel('puntosCercanos');
}

// Calcular distancia entre dos puntos (fórmula de Haversine simplificada)
function calcularDistancia(lat1, lng1, lat2, lng2) {
    const R = 6371; // Radio de la Tierra en km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Aplicar configuración del modal
function aplicarConfiguracion() {
    // Implementar aplicación de configuración avanzada
    modalConfiguracion.hide();
    mostrarAlerta('Configuración aplicada', 'success');
}

// Función auxiliar para mostrar carga
function mostrarCarga(mostrar) {
    // Implementar indicador de carga si es necesario
}
</script>
{% endblock %}
